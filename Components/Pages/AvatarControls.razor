@page "/AvatarControls"
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Authorization
@using ZeniControlSuite.Authentication;
@using ZeniControlSuite.Models;
@using MudBlazor.Services
@using MudBlazor.Utilities
@attribute [Authorize(Roles = "Admin, Avatar")]

<PageTitle>Avatar Controls</PageTitle>

<h1 style="text-align: center;">Avatar Controls | @AvatarsService.selectedAvatar.Name</h1>
<MudDivider></MudDivider>

<br />
<br />

<AuthorizeView>
    <Authorized>

        <MudGrid Spacing="3" Justify="Justify.FlexStart">
            @if (!AvatarsService.avatarsLoaded)
            {
                <MudItem>
                    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
                </MudItem>
            }
            else
            {
                foreach (AvatarControl control in AvatarsService.selectedAvatar.Controls)
                {
                    if (!@context.User.IsInRole("Admin"))
                    {
                        bool hasRole = true;
                        foreach (string role in control.RequiredRoles)
                        {
                            if (!context.User.IsInRole(role))
                            {
                                hasRole = false;
                                continue;
                            }
                        }

                        if (!hasRole)
                        {
                            continue;
                        }
                    }

                    <MudItem>
                        <MudPaper Style="@("width: 200px; height: 270px; padding-top: 10px")" Class="pa-2 mt-2 justify-center align-start">

                            <MudText Typo="Typo.h6" Align="Align.Center">@control.Name</MudText>

                            <div style="height: 8px"></div>

                            @if (control is ContTypeButton contBut)
                            {

                            }

                            else if (control is ContTypeToggle contTog)
                            {
                                Parameter _Param = AvatarsService.selectedAvatar.Parameters[contTog.Parameter.Address];

                                <div style="width: 140px; height: 140px; margin-left:auto; margin-right:auto">
                                    @if (_Param.Value == contTog.ValueOff)
                                    {
                                        <MudButton Style="@("width: 100%; height: 100%;")" Variant="Variant.Outlined" Color="Color.Default" OnClick="@(() => ControlTogglePress(contTog))">
                                            <MudImage Src="@control.IconPath" Style="width: 100%; height: 100%;" Alt="Off"></MudImage>
                                        </MudButton>
                                    }
                                    else
                                    {
                                        <MudButton Style="@("width: 100%; height: 100%;")" Variant="Variant.Filled" Color="Color.Info" OnClick="@(() => ControlTogglePress(contTog))">
                                            <MudImage Src="@control.IconPath" Style="width: 100%; height: 100%;" Alt="On"></MudImage>
                                        </MudButton>
                                    }
                                </div>
                            }

                            else if (control is ContTypeRadial contRad)
                            {
                                Parameter _Param = AvatarsService.selectedAvatar.Parameters[contRad.Parameter.Address];

                                <MudPaper Style="@("margin-left:auto; margin-right:auto; width: 140px; height: 140px; padding: 8px; opacity: 1.0;")" Class="border-1 border-secondary">
                                    <MudButton Style="@("width: 100%; height: 40px; font-size: 25")" Variant="Variant.Outlined" DropShadow="false" Color="Color.Info">@contRad.Parameter.Value</MudButton>
                                    <div style="height: 10px;" />
                                    <MudSlider Color="Color.Info" Size="Size.Large" Min="contRad.ValueMin" Max="contRad.ValueMax" Step="0.01f" Value="_Param.Value" ValueChanged="@((float value) => ControlRadialChange(contRad, value))" />
                                </MudPaper>
                            }

                            else if (control is ContTypeHSV contHSV)
                            {
                                MudColor mudColorEstimate = EstimateMudColor(contHSV, 1.0f);
                                string hexColorEstimate = mudColorEstimate.ToString(MudColorOutputFormats.Hex);

                                string styleBackground = $"position: absolute; width: 100%; height: 100%; background-color: {hexColorEstimate}";

                                Parameter _ParamHue = AvatarsService.selectedAvatar.Parameters[contHSV.ParameterHue.Address];
                                Parameter _ParamSat = AvatarsService.selectedAvatar.Parameters[contHSV.ParameterSaturation.Address];
                                Parameter _ParamBri = AvatarsService.selectedAvatar.Parameters[contHSV.ParameterBrightness.Address];

                                <MudPaper Style="@($"margin-left:auto; margin-right:auto; width: 150px; height: 15px; padding-left: 16px; padding-right: 16px; opacity: 1.0; background-color: {hexColorEstimate}")" Class="border-1 border-secondary">
                                </MudPaper>

                                <MudPaper Style="@($"margin-left:auto; margin-right:auto; width: 150px; height: 185px; padding-left: 16px;  padding-right: 16px; opacity: 1.0")" Class="border-1 border-secondary">
                                    <MudSlider Color="Color.Error" Size="Size.Large" Min="0.0f" Max="1.0f" Step="0.005f" Value="_ParamHue.Value" ValueChanged="@((float value) => ControlHSVChange(contHSV, HSVParamValue.Hue, value))" > Hue </MudSlider>
                                    <MudSlider Color="Color.Info" Size="Size.Large" Min="0.0f" Max="1.0f" Step="0.005f" Value="_ParamSat.Value" ValueChanged="@((float value) => ControlHSVChange(contHSV, HSVParamValue.Saturation, value))"> Saturation </MudSlider>
                                    <MudSlider Color="Color.Warning" Size="Size.Large" Min="0.0f" Max="1.0f" Step="0.005f" Value="_ParamBri.Value" ValueChanged="@((float value) => ControlHSVChange(contHSV, HSVParamValue.Brightness, value))"> Value </MudSlider>
                                </MudPaper>


                                @* this sometimes gets stuck in a loop, so just gonna comment it out for now
                                <MudPaper Style="@("margin-left:auto; margin-right:auto; width: 140px; height: 140px; padding: 2px; opacity: 1.0;background-color: " + hex)">
                                    @for (int i = 0; i < 2; i++) //two of them to cover the whole area
                                    {
                                        <MudColorPicker ShowToolbar="true" ShowAlpha="false" ShowModeSwitch="false"
                                                        ThrottleInterval="100" DragEffect="@true" Elevation="8" Class="fade" Style="@("width: 100%; height 100%")"
                                                        Label="ColorPicker" PickerVariant="PickerVariant.Inline" ColorPickerMode="ColorPickerMode.HSL" Palette="HSVPallet"
                                                        Value="contHSV.targetColor" ValueChanged="@((MudBlazor.Utilities.MudColor color) => ControlHSVChange(contHSV, color))" />
                                    }
                                </MudPaper> 
                                *@
                            }

                            else
                            {
                                <MudText Typo="Typo.caption">Unknown Type</MudText>
                            }




                        </MudPaper>
                    </MudItem>
                }
            }
        </MudGrid>

    </Authorized>
</AuthorizeView>


@code {
    public IEnumerable<MudColor> HSVPallet { get; set; } = new MudColor[]
    {
        "#ffffff", "#010000", "#ff0000", "#fffb00", "#000dff",
        "#ff00ff", "#00f7ff", "#00ff73", "#9000ff", "#ffa600",
        "#ffcc00", "#003399", "#00a2ff", "#003c80", "#800000",
        "#ffcccc", "#ffccfb", "#ff8af9", "#ff3396", "#00a128",
        "#8f8f8f", "#000d96", "#6800a8", "#ffffff", "#ffffff",
        "#ffffff", "#ffffff", "#ffffff", "#ffffff", "#ffffff",
        "#ffffff", "#ffffff", "#ffffff", "#ffffff", "#ffffff"
    };
}